---
name: Enforce Correct Version Update

permissions:
  contents: read
  statuses: write
  pull-requests: read

on:
  pull_request:
    branches:
      - main
    paths:
      - 'api/app/**/*.py'

jobs:
  detect-changes:
    uses: ./.github/workflows/detect-changed-versions.yml
  suggest-version-bump:
    uses: ./.github/workflows/suggest-version-bump.yml

  enforce-version:
    needs: detect-changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set changed versions
        id: set_versions
        run: |
          echo "VERSIONS=${{ needs.detect-changes.outputs.versions }}" >> "$GITHUB_ENV"

      - name: Check version bumps
        id: check_versions
        run: |
          git fetch origin main
          BASE_SHA=$(git merge-base HEAD origin/main)
          EXIT_CODE=0
          REPORT=""

          # Function to extract version from file
          get_version() {
            local file="$1"
            if [ -f "$file" ]; then
              grep -E "^__version__\s*=" "$file" | sed -E "s/^__version__\s*=\s*['\"]([^'\"]+)['\"].*$/\1/"
            fi
          }

          # Check api/app/version.py
          OLD_SERVICE_VERSION=$(git show "$BASE_SHA:api/app/version.py" 2>/dev/null | grep -E "^__version__\s*=" | sed -E "s/^__version__\s*=\s*['\"]([^'\"]+)['\"].*$/\1/" || echo "")
          NEW_SERVICE_VERSION=$(get_version "api/app/version.py")

          if [ "$OLD_SERVICE_VERSION" = "$NEW_SERVICE_VERSION" ]; then
            REPORT+="ðŸ›‘ Python code was changed, but `__version__` value was not updated in `api/app/version.py` (still $NEW_SERVICE_VERSION)\n"
            EXIT_CODE=1
          else
            REPORT+="âœ… `api/app/version.py` version changed: $OLD_SERVICE_VERSION â†’ $NEW_SERVICE_VERSION\n"
          fi

          # Check each changed version folder
          for v in $VERSIONS; do
            OLD_API_VERSION=$(git show "$BASE_SHA:api/app/routes/$v/__init__.py" 2>/dev/null | grep -E "^__version__\s*=" | sed -E "s/^__version__\s*=\s*['\"]([^'\"]+)['\"].*$/\1/" || echo "")
            NEW_API_VERSION=$(get_version "api/app/routes/$v/__init__.py")

            if [ "$OLD_API_VERSION" = "$NEW_API_VERSION" ]; then
              REPORT+="ðŸ›‘ Version $v was modified, but `__version__` value was not updated in `api/app/routes/$v/__init__.py` (still $NEW_API_VERSION)\n"
              EXIT_CODE=1
            else
              REPORT+="âœ… `api/app/routes/$v/__init__.py` version changed: $OLD_API_VERSION â†’ $NEW_API_VERSION\n"
            fi
          done

          echo -e "$REPORT"
          echo -e "$REPORT" >> "$GITHUB_STEP_SUMMARY"
          exit $EXIT_CODE
